#!/usr/bin/env bash
# server – Devtainer CLI launcher
# shellcheck disable=SC1090,SC2155

set -euo pipefail

###############################################################################
# 0. PATHS & CONSTANTS
###############################################################################
DIR="$(dirname -- "$(readlink -f -- "$0" || greadlink -f -- "$0")")"
CFG="$DIR/docker"
ENV_MAIN="$DIR/.env"
ENV_DOCKER="$CFG/.env"
COMPOSE_FILE="$CFG/compose/main.yaml"

COLOR() { printf '\033[%sm' "$1"; }
RED=$(COLOR '0;31') GREEN=$(COLOR '0;32') CYAN=$(COLOR '0;36')
YELLOW=$(COLOR '1;33') BLUE=$(COLOR '0;34') MAGENTA=$(COLOR '0;35')
NC=$(COLOR '0')

# Default behavior: QUIET
VERBOSE=0

#───────────────────────────────────────────────────────────────────────────────
# 0. GLOBAL ERROR HANDLER
#───────────────────────────────────────────────────────────────────────────────
command_not_found_handle() {
  local unknown="$1"
  [[ $unknown == cmd_* ]] && unknown=${unknown#cmd_}
  printf "\n%bError:%b Unknown command '%b'\n\n" "$RED" "$NC" "$unknown"
  cmd_help
  exit 1
}

trap 'on_error $? $LINENO "$BASH_COMMAND"' ERR
on_error() {
  printf "\n%bError:%b '%s' failed at line %d (exit %d)\n\n" \
    "$RED" "$NC" "$3" "$2" "$1"
  exit "$1"
}

###############################################################################
# 1. COMMON HELPERS
###############################################################################
die() {
  printf "%bError:%b %s\n" "$RED" "$NC" "$*"
  exit 1
}

need() {
  local group found cmd
  for group in "$@"; do
    IFS='|,' read -ra alts <<<"$group"
    found=0
    for cmd in "${alts[@]}"; do
      command -v "$cmd" &>/dev/null && { found=1; break; }
    done
    ((found)) && continue
    local miss=${alts[*]}
    miss=${miss// / or }
    die "Missing command(s): $miss"
  done
}

ensure_files_exist() {
  local rel abs dir
  for rel in "$@"; do
    abs="${DIR}${rel}"
    dir="${abs%/*}"

    if [[ ! -d $dir ]]; then
      if mkdir -p "$dir" 2>/dev/null; then
        printf "%b- Created directory %s%b\n" "$YELLOW" "$dir" "$NC"
      else
        printf "%b- Warning:%b cannot create directory %s (permissions?)\n" \
          "$YELLOW" "$NC" "$dir"
        continue
      fi
    elif [[ ! -w $dir ]]; then
      printf "%b- Warning:%b directory not writable: %s\n" "$YELLOW" "$NC" "$dir"
    fi

    if [[ -e $abs ]]; then
      [[ -w $abs ]] || printf "%b- Warning:%b file not writable: %s\n" "$YELLOW" "$NC" "$abs"
    else
      if : >"$abs" 2>/dev/null; then
        printf "%b- Created file %s%b\n" "$YELLOW" "$abs" "$NC"
      else
        printf "%b- Error:%b cannot create file %s (permissions?)\n" "$RED" "$NC" "$abs"
      fi
    fi
  done
}

docker_compose() {
  docker compose \
    --project-directory "$DIR" \
    -f "$COMPOSE_FILE" \
    --env-file "$ENV_DOCKER" "$@"
}

# ── docker compose wrappers (QUIET by default) ────────────────────────────────
dc_up() {
  if ((VERBOSE)); then docker_compose up "$@"
  else docker_compose up --quiet-pull "$@"
  fi
}

dc_pull() {
  if ((VERBOSE)); then docker_compose pull "$@"
  else docker_compose pull -q "$@"
  fi
}

dc_build() {
  if ((VERBOSE)); then docker_compose build "$@"
  else docker_compose build --quiet "$@"
  fi
}

# helper for our own minimal logging (still shows in quiet mode)
logv() { ((VERBOSE)) && printf "%b[%s]%b %s\n" "$CYAN" "${1:-info}" "$NC" "${2:-}" >&2 || true; }
logq() { printf "%b[%s]%b %s\n" "$CYAN" "${1:-info}" "$NC" "${2:-}" >&2; }

# Unified prompt helper (used by env_init + profiles)
read_default() {
  local prompt=$1 default=$2 input
  read -rp "$(printf '%b%s [default: %s]:%b ' "$CYAN" "$prompt" "$default" "$NC")" input
  printf '%s' "${input:-$default}"
}

ask_yes() {
  local prompt="$1" ans
  read -rp "$(printf "%b%s (y/n): %b" "$BLUE" "$prompt" "$NC")" ans
  [[ "${ans,,}" == "y" ]]
}

update_env() {
  local file=$1 var=$2 val=$3
  mkdir -p "$(dirname "$file")"
  [[ -f "$file" ]] || { printf "%bFile '%s' not found. Creating one.%b\n" "$YELLOW" "$file" "$NC"; : >"$file"; }
  var=$(echo "$var" | sed 's/[]\/$*.^|[]/\\&/g')
  grep -qE "^[# ]*$var=" "$file" 2>/dev/null &&
    sed -Ei "s|^[# ]*($var)=.*|\1=$val|" "$file" ||
    echo "${var}=${val}" >>"$file"
}

http_reload() {
  printf "%bReloading HTTP…%b\n" "$GREEN" "$NC"
  docker ps -qf name=NGINX &>/dev/null && docker exec NGINX nginx -s reload &>/dev/null || true
  docker ps -qf name=APACHE &>/dev/null && docker exec APACHE apachectl graceful &>/dev/null || true
  printf "%bHTTP reloaded%b\n" "$GREEN" "$NC"
}

###############################################################################
# 2. PERMISSIONS FIX-UP
###############################################################################
fix_perms() {
  [[ "$OSTYPE" =~ (msys|cygwin) ]] && return
  ((EUID == 0)) || die "Please run with sudo."

  chmod 755 "$DIR"
  chmod 2775 "$DIR/configuration"
  find "$DIR/configuration" -type f ! -perm 664 -exec chmod 664 {} +

  chmod 755 "$DIR/docker"
  find "$DIR/docker" -type f ! -perm 644 -exec chmod 644 {} +

  chmod 2777 "$DIR/data"
  mkdir -p "$DIR/data/cloudbeaver" "$DIR/data/mysql" "$DIR/data/postgresql" "$DIR/data/mongo" \
    "$DIR/data/mariadb" "$DIR/data/elasticsearch" "$DIR/data/redis" \
    "$DIR/data/redis-insight" "$DIR/data/kibana"
  find "$DIR/data" -mindepth 1 -maxdepth 1 -type d -exec chmod 2777 {} +
  find "$DIR/data" -type f -exec chmod 666 {} +

  chmod -R 777 "$DIR/logs"
  chown -R "$USER:docker" "$DIR/logs"

  chmod 755 "$DIR/bin"
  find "$DIR/bin" -type f ! -name '*.bat' -exec chmod 744 {} +
  chmod +x "$DIR/server"

  ln -fs "$DIR/server" /usr/local/bin/server
  printf "%bPermissions assigned.%b\n" "$GREEN" "$NC"
}

###############################################################################
# 3. DOMAIN & PROFILE UTILITIES
###############################################################################
mkhost() { docker exec SERVER_TOOLS mkhost "$@"; }

setup_domain() {
  mkhost --RESET
  docker exec -it SERVER_TOOLS mkhost
  local php_prof svr_prof
  php_prof=$(mkhost --ACTIVE_PHP_PROFILE || true)
  svr_prof=$(mkhost --APACHE_ACTIVE || true)
  [[ -n $php_prof ]] && modify_profiles add "$php_prof"
  [[ -n $svr_prof ]] && modify_profiles add "$svr_prof"
  mkhost --RESET
  http_reload
}

modify_profiles() {
  local action=$1
  shift
  local file=$ENV_DOCKER var=COMPOSE_PROFILES
  local -a existing updated

  if [[ -r $file ]]; then
    local line value
    line=$(grep -E "^${var}=" "$file" | tail -n1 || true)
    value=${line#*=}
    IFS=',' read -r -a existing <<<"$value"
  fi

  case $action in
  add)
    local p
    for p; do
      [[ -n $p && ! " ${existing[*]} " =~ " $p " ]] && updated+=("$p")
    done
    updated+=("${existing[@]}")
    ;;
  remove)
    local old
    for old in "${existing[@]}"; do
      [[ ! " $* " =~ " $old " ]] && updated+=("$old")
    done
    ;;
  *) die "modify_profiles: invalid action '$action'" ;;
  esac

  update_env "$file" "$var" "$(
    IFS=,
    echo "${updated[*]}"
  )"
}

# ─────────────────────────────────────────────────────────────────────────────
# Profiles (merged from docker/utilities/profiles)
# ─────────────────────────────────────────────────────────────────────────────

# SERVICE → PROFILE map (single profile per service)
declare -A SERVICES=(
  [ELASTICSEARCH]="elasticsearch"
  [MYSQL]="mysql"
  [MARIADB]="mariadb"
  [MONGODB]="mongodb"
  [REDIS]="redis"
  [POSTGRESQL]="postgresql"
)

# stable prompt order (associative arrays are unordered)
declare -a SERVICE_ORDER=(ELASTICSEARCH MYSQL MARIADB MONGODB REDIS POSTGRESQL)

# PROFILE → KEY=DEFAULT entries
declare -A PROFILE_ENV=(
  [elasticsearch]="ELASTICSEARCH_VERSION=8.18.0 ELASTICSEARCH_PORT=9200"
  [mysql]="MYSQL_VERSION=latest MYSQL_PORT=3306 MYSQL_ROOT_PASSWORD=12345 MYSQL_USER=infocyph MYSQL_PASSWORD=12345 MYSQL_DATABASE=localdb"
  [mariadb]="MARIADB_VERSION=latest MARIADB_PORT=3306 MARIADB_ROOT_PASSWORD=12345 MARIADB_USER=infocyph MARIADB_PASSWORD=12345 MARIADB_DATABASE=localdb"
  [mongodb]="MONGODB_VERSION=latest MONGODB_PORT=27017 MONGODB_ROOT_USERNAME=root MONGODB_ROOT_PASSWORD=12345"
  [redis]="REDIS_VERSION=latest REDIS_PORT=6379"
  [postgresql]="POSTGRES_VERSION=latest POSTGRES_PORT=5432 POSTGRES_USER=postgres POSTGRES_PASSWORD=postgres POSTGRES_DATABASE=postgres"
)

# Queues for “deferred” operations
declare -a PENDING_ENVS=()
declare -a PENDING_PROFILES=()

queue_env()     { PENDING_ENVS+=( "$1" ); }
queue_profile() { PENDING_PROFILES+=( "$1" ); }

flush_envs() {
  local env_file="$ENV_DOCKER" kv key val
  for kv in "${PENDING_ENVS[@]}"; do
    IFS='=' read -r key val <<<"$kv"
    update_env "$env_file" "$key" "$val"
  done
}

flush_profiles() {
  local profile
  for profile in "${PENDING_PROFILES[@]}"; do
    modify_profiles add "$profile"
  done
}

process_service() {
  local service="$1"
  printf "\n%b→ %s%b\n" "$YELLOW" "$service" "$NC"
  ask_yes "Enable $service?" || { printf "%bSkipping %s%b\n" "$RED" "$service" "$NC"; return; }

  local profile="${SERVICES[$service]}"
  queue_profile "$profile"

  printf "%bEnter value(s) for %s:%b\n" "$BLUE" "$service" "$NC"
  local pair key def val
  for pair in ${PROFILE_ENV[$profile]}; do
    IFS='=' read -r key def <<<"$pair"
    val=$(read_default "$key" "$def")
    queue_env "$key=$val"
  done
}

process_all() {
  local svc
  for svc in "${SERVICE_ORDER[@]}"; do
    process_service "$svc"
  done
  flush_envs
  flush_profiles
  printf "\n%b✅ All services configured!%b\n" "$GREEN" "$NC"
}

###############################################################################
# 4. LAUNCH PHP CONTAINER INSIDE DOCROOT
###############################################################################
launch_php() {
  local domain=$1 suffix
  local nconf="$DIR/configuration/nginx/$domain.conf"
  local aconf="$DIR/configuration/apache/$domain.conf"
  [[ -f $nconf ]] || die "No Nginx config for $domain"

  local docroot php
  if grep -q fastcgi_pass "$nconf"; then
    php=$(grep -Eo 'fastcgi_pass ([^:]+):9000' "$nconf" | awk '{print $2}' | sed 's/:9000$//')
    docroot=$(grep -m1 -Eo 'root [^;]+' "$nconf" | awk '{print $2}')
  else
    [[ -f $aconf ]] || die "No Apache config for $domain"
    docroot=$(grep -m1 -Eo 'DocumentRoot [^ ]+' "$aconf" | awk '{print $2}')
    php=$(grep -Eo 'proxy:fcgi://([^:]+):9000' "$aconf" | sed 's/.*:\/\/\([^:]*\):.*/\1/')
  fi

  [[ $php ]] || die "Could not detect PHP container for $domain"
  [[ $docroot ]] || docroot=/app
  for suffix in public dist public_html; do
    [[ $docroot == */$suffix ]] && { docroot=${docroot%/*}; break; }
  done

  php=$(echo "$php" | tr ' \n' '\n' | awk 'NF && !seen[$0]++' | paste -sd' ' -)
  docker exec -it "$php" bash --login -c "cd '$docroot' && exec bash"
}

###############################################################################
# 5. ENV + CERT
###############################################################################
detect_timezone() {
  if command -v timedatectl &>/dev/null; then
    timedatectl show -p Timezone --value
  elif [[ -n ${TZ-} ]]; then
    printf '%s' "$TZ"
  elif [[ -r /etc/timezone ]]; then
    </etc/timezone
  elif command -v powershell.exe &>/dev/null; then
    powershell.exe -NoProfile -Command "[System.TimeZoneInfo]::Local.Id" 2>/dev/null | tr -d '\r'
  else
    date +%Z
  fi
}

env_init() {
  local env_file="$ENV_DOCKER"
  printf "%bBootstrapping environment defaults…%b\n" "$YELLOW" "$NC"

  local default_tz tz
  default_tz=$(detect_timezone)
  tz=$(read_default "Timezone (TZ)" "$default_tz")

  local default_user user default_uid default_gid uid gid
  default_user=${USER:-$(id -un)}
  user=$(read_default "User" "$default_user")
  if id "$user" &>/dev/null; then
    default_uid=$(id -u "$user")
    default_gid=$(id -g "$user")
  else
    default_uid=$(id -u)
    default_gid=$(id -g)
  fi
  uid=$(read_default "User UID" "$default_uid")
  gid=$(read_default "User GID" "$default_gid")

  local kv key val
  for kv in "TZ=$tz" "USER=$user" "UID=$uid" "GID=$gid"; do
    IFS='=' read -r key val <<<"$kv"
    update_env "$env_file" "$key" "$val"
  done
  printf "%bDefaults saved!%b\n" "$GREEN" "$NC"
}

install_ca() {
  local src="$DIR/configuration/rootCA/rootCA.pem"
  local dest=/usr/local/share/ca-certificates/rootCA.crt
  [[ $EUID -eq 0 ]] || die "install certificate requires sudo"
  [[ -r $src ]] || die "certificate not found: $src"

  printf "%bInstalling root CA…%b\n" "$CYAN" "$NC"
  install -m 644 "$src" "$dest"
  command -v update-ca-certificates &>/dev/null && update-ca-certificates
  command -v trust &>/dev/null && trust extract-compat
  printf "%bRoot CA installed → %s%b\n" "$GREEN" "$dest" "$NC"
}

###############################################################################
# Compose helpers for rebuild
###############################################################################
compose_has_build() { # compose_has_build <service>
  local svc="$1"
  docker_compose config 2>/dev/null | awk -v s="$svc" '
    $1=="services:" {in_services=1; next}
    in_services && $0 ~ ("^  " s ":$") {in_svc=1; next}
    in_svc && $0 ~ /^  [A-Za-z0-9_.-]+:$/ {exit 1}
    in_svc && $0 ~ /^    build:/ {exit 0}
    END {exit 1}
  '
}

compose_image_for_service() { # compose_image_for_service <service>
  local svc="$1"
  docker_compose config 2>/dev/null | awk -v s="$svc" '
    $1=="services:" {in_services=1; next}
    in_services && $0 ~ ("^  " s ":$") {in_svc=1; next}
    in_svc && $0 ~ /^  [A-Za-z0-9_.-]+:$/ {exit 0}
    in_svc && $0 ~ /^    image:/ {
      sub(/^    image:[[:space:]]*/, "", $0)
      print $0
      exit 0
    }
  '
}

###############################################################################
# 6. COMMANDS
###############################################################################
cmd_up() { dc_up "$@"; }

cmd_start() {
  dc_up -d "$@"
  http_reload
}

cmd_reload() { cmd_start "$@"; }
cmd_stop() { docker_compose down; }
cmd_down() { cmd_stop; }
cmd_restart() { cmd_stop; cmd_start; }
cmd_reboot() { cmd_restart; }

normalize_service() {
  local raw="${1:-}"
  local s="${raw//[[:space:]]/}"
  [[ -n "$s" ]] || { printf '%s' ""; return 0; }

  local low="${s,,}"

  # PHP: collapse separators, then pick first two digits after "php"
  local key="${low//_/}"
  key="${key//-/}"
  if [[ "$key" =~ ^php ]]; then
    local ver="${key#php}"
    ver="${ver//[^0-9]/}"
    if [[ "$ver" =~ ^([0-9])([0-9]).* ]]; then
      printf 'php%s%s' "${BASH_REMATCH[1]}" "${BASH_REMATCH[2]}"
      return 0
    fi
    printf 'php'
    return 0
  fi

  # others: underscore -> hyphen
  low="${low//_/-}"
  while [[ "$low" == *"--"* ]]; do low="${low//--/-}"; done
  printf '%s' "$low"
}

# rebuild:
# - server rebuild all
# - server rebuild a b c
# No stack "down" here.
cmd_rebuild() {
  local -a svcs=()
  local arg

  (($# > 0)) || die "Usage: server rebuild all | server rebuild <service...>"

  if [[ "${1,,}" == "all" ]]; then
    mapfile -t svcs < <(docker_compose config --services 2>/dev/null)
    [[ ${#svcs[@]} -gt 0 ]] || die "No services found (docker compose config --services failed?)"
  else
    for arg in "$@"; do
      svcs+=("$(normalize_service "$arg")")
    done
  fi

  local svc
  for svc in "${svcs[@]}"; do
    [[ -n "$svc" ]] || continue

    if compose_has_build "$svc"; then
      logq rebuild "build/recreate $svc"
      dc_build --no-cache --pull "$svc"
      dc_up -d --no-deps --force-recreate "$svc"
      continue
    fi

    logq rebuild "pull/recreate $svc"

    docker_compose rm -sf "$svc" >/dev/null 2>&1 || true

    local img
    img="$(compose_image_for_service "$svc")"
    if [[ -n "${img:-}" ]]; then
      docker rmi -f "$img" >/dev/null 2>&1 || true
    fi

    dc_pull "$svc"
    dc_up -d --no-deps --force-recreate "$svc"
  done
}

cmd_config() { docker_compose config; }
cmd_tools() { docker exec -it SERVER_TOOLS bash; }
cmd_lzd() { docker exec -it SERVER_TOOLS lazydocker; }
cmd_lazydocker() { cmd_lzd; }
cmd_http() { [[ ${1:-} == reload ]] && http_reload; }
cmd_cli() { cmd_core "$@"; }
cmd_core() {
  local domain=${1:-}
  [[ -n $domain ]] || die "Usage: server core <domain>"
  launch_php "$domain"
}

cmd_setup() {
  update_env "$ENV_DOCKER" WORKING_DIR "$DIR"
  update_env "$ENV_DOCKER" USER "$(id -un)"
  update_env "$ENV_DOCKER" UID "$(id -u)"
  update_env "$ENV_DOCKER" GID "$(id -g)"
  case ${1:-} in
  permission|permissions|perms|perm) fix_perms ;;
  domain) setup_domain ;;
  profiles|profile) process_all ;;
  *) die "setup <permissions|domain|profiles>" ;;
  esac
}

cmd_env() {
  case ${1:-} in
  init|boot) env_init ;;
  edit) die "ToDo" ;;
  *) die "env <init|edit>" ;;
  esac
}

cmd_install() { [[ ${2:-} == certificate ]] && install_ca || die "install certificate"; }

###############################################################################
# NOTIFY
###############################################################################
notify_watch() {
  local container="${1:-SERVER_TOOLS}"
  local prefix="__HOST_NOTIFY__"

  need docker notify-send

  trap - ERR
  set +e
  set +o pipefail

  local _disp="${DISPLAY-}"
  local _dbus="${DBUS_SESSION_BUS_ADDRESS-}"
  local _stop=0

  _watcher_notify() {
    local urgency="${1:-critical}" title="${2:-Notifier}" body="${3:-Watcher event}"
    (env DISPLAY="${_disp-}" DBUS_SESSION_BUS_ADDRESS="${_dbus-}" \
      setsid -f notify-send -u "$urgency" -t 2500 "$title" "$body" \
      >/dev/null 2>&1 || true) &
  }

  _watcher_int_term() {
    _stop=1
    _watcher_notify critical "Notifier" "Notification watcher interrupted/exiting"
    printf "%b[watcher]%b Notification watcher interrupted/exiting\n" "$RED" "$NC" >&2
  }
  trap _watcher_int_term INT TERM

  local grep_cmd=(grep -a --line-buffered -E "^${prefix}([[:space:]]|$)")
  command -v stdbuf &>/dev/null && grep_cmd=(stdbuf -oL -eL "${grep_cmd[@]}")

  printf "%bNotify Watch:%b monitoring is active. Ctrl+C to stop.\n" "$GREEN" "$NC"

  while ((_stop == 0)); do
    if ! docker inspect -f '{{.State.Running}}' "$container" 2>/dev/null | grep -q true; then
      _watcher_notify critical "Notifier" "Watcher stopped: $container is not running"
      printf "%b[watcher]%b %s is not running; exiting.\n" "$RED" "$NC" "$container" >&2
      break
    fi

    docker logs -f --tail 0 "$container" 2>&1 |
      ("${grep_cmd[@]}" || true) |
      while IFS=$'\t' read -r _ f1 f2 f3 f4 rest; do
        local timeout urgency title body
        if [[ "${f1:-}" =~ ^[0-9]{1,6}$ ]]; then
          timeout="$f1"
          urgency="${f2:-normal}"
          title="${f3:-Notification}"
          body="${f4:-}"
        else
          timeout="2500"
          urgency="${f1:-normal}"
          title="${f2:-Notification}"
          body="${f3:-}"
        fi
        [[ -n "${rest:-}" ]] && body+=$'\t'"${rest}"
        case "$urgency" in low|normal|critical) ;; *) urgency="normal" ;; esac

        notify-send -t "$timeout" -u "$urgency" "$title" "$body" >/dev/null 2>&1 || true
        printf "%s [%s] %s - %s\n" "$(date '+%Y-%m-%d %H:%M:%S')" "$urgency" "$title" "$body" >&2
      done

    ((_stop)) && break

    if docker inspect -f '{{.State.Running}}' "$container" 2>/dev/null | grep -q true; then
      _watcher_notify critical "Notifier" "Watcher lost log stream (docker logs ended). Reconnecting…"
      printf "%b[watcher]%b docker logs ended; reconnecting...\n" "$YELLOW" "$NC" >&2
      sleep 1
      continue
    fi

    _watcher_notify critical "Notifier" "Watcher stopped: $container stopped"
    printf "%b[watcher]%b %s stopped; exiting.\n" "$RED" "$NC" "$container" >&2
    break
  done

  trap - INT TERM
  set -euo pipefail

  ((_stop)) && return 130
  return 0
}

notify_test() {
  local title="${1:-Notifier OK}"
  local body="${2:-Hello from host via SERVER_TOOLS}"
  docker exec SERVER_TOOLS notify -t 2500 -u normal "$title" "$body"
}

cmd_notify() {
  case ${1:-watch} in
  watch) notify_watch "${2:-SERVER_TOOLS}" ;;
  test) notify_test "${2:-Notifier OK}" "${3:-Hello from host}" ;;
  *) die "notify <watch [container]|test \"Title\" \"Body\">" ;;
  esac
}

cmd_help() {
  cat <<EOF
${CYAN}Usage:${NC} server [--verbose|-v] <command> [options]

${CYAN}Default:${NC} quiet docker compose operations. Add ${CYAN}-v${NC} / ${CYAN}--verbose${NC} to see pull/build progress.

${CYAN}Core commands:${NC}
  up / start                 Start docker stack (quiet pull by default)
  stop / down                Stop stack
  reload / restart           Restart stack + reload HTTP
  rebuild all|<svc...>       Rebuild/pull services (no full down)
  config                     Validate compose
  tools                      Enter SERVER_TOOLS container
  lzd | lazydocker           Start LazyDocker
  http reload                Reload Nginx/Apache
  core <domain>              Open bash in PHP container for <domain>

${CYAN}Setup commands:${NC}
  setup permissions          Assign/Fix directory/file permissions
  setup domain               Setup domain
  setup profiles             Setup database profiles

${CYAN}Env commands:${NC}
  env init|boot              Setup Initial level environment variables (TZ, USER, UID, GID)

${CYAN}Misc:${NC}
  install certificate        Install local rootCA
  notify watch [container]   Watch SERVER_TOOLS notifications and show desktop popups
  notify test "T" "B"        Send a test notification into SERVER_TOOLS
  help                       This help
EOF
}

###############################################################################
# 7. MAIN
###############################################################################
main() {
  need docker readlink,greadlink
  ensure_files_exist "/docker/.env" "/configuration/php/php.ini"

  [[ $# -gt 0 ]] || { cmd_help; exit 1; }

  while [[ $# -gt 0 ]]; do
    case "$1" in
    -v|--verbose) VERBOSE=1; shift ;;
    -q|--quiet)   VERBOSE=0; shift ;;
    --) shift; break ;;
    -*) die "Unknown global option: $1" ;;
    *)  break ;;
    esac
  done

  [[ $# -gt 0 ]] || { cmd_help; exit 1; }

  case "${1,,}" in
  php|mariadb|mariadb-dump|mysql|mysql-dump|psql|pg_dump|pg_restore|composer)
    exec "$DIR/bin/$1" "${@:2}"
    ;;
  redis|redis-cli)
    exec "$DIR/bin/redis-cli" "${@:2}"
    ;;
  esac

  cmd_"${1,,}" "${@:2}"
}

main "$@"
