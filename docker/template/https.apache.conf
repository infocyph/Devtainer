<VirtualHost *:443>
    # Site Identity
    ServerName {{SERVER_NAME}}
    ServerAlias www.{{SERVER_NAME}}

    # Document Root (Matching Nginx `/app{{DOC_ROOT}}`)
    DocumentRoot /app{{DOC_ROOT}}
    DirectoryIndex index.php index.html index.htm

    # SSL Configuration (Using mkcert)
    SSLEngine on
    SSLCertificateFile /etc/mkcert/{{SERVER_NAME}}/fullchain.pem     # Full chain (cert + intermediates)
    SSLCertificateKeyFile /etc/mkcert/{{SERVER_NAME}}/privkey.pem    # Private key
    SSLProtocol all -SSLv2 -SSLv3
    SSLCipherSuite "ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:DES-CBC3-SHA"
    SSLCompression off  # Prevent CRIME attack
    SSLHonorCipherOrder on # Enforce server-side cipher preference order

    # OCSP Stapling for Performance
    SSLUseStapling on
    SSLStaplingResponderTimeout 5
    SSLStaplingReturnResponderErrors off
    SSLStaplingCache "shmcb:/var/run/ocsp(128000)"

    # Enable HTTP/2 and HTTP/1.1 fallback
    Protocols h2 http/1.1

    # Limit client request body size (Converted from Nginx)
    LimitRequestBody {{CLIENT_MAX_BODY_SIZE}}

    # Deny access to private Laravel directories
    <DirectoryMatch "/(storage|bootstrap|config|database|resources|tests)/">
        Require all denied
    </DirectoryMatch>

    # Allow Laravel public files
    <Directory "/app{{DOC_ROOT}}">
        AllowOverride All
        Require all granted
    </Directory>

    # Deny execution of PHP scripts in /storage
    <Directory "/app{{DOC_ROOT}}/storage">
        <FilesMatch "\.(php|pl|py|sh|cgi|htaccess)$">
            Require all denied
        </FilesMatch>
    </Directory>

    # Enable Gzip Compression (Matching Nginx)
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain text/css text/xml text/javascript application/json application/javascript application/x-javascript application/xml+rss application/vnd.ms-fontobject application/x-font-ttf font/opentype image/svg+xml image/x-icon
    </IfModule>

    # Caching Headers for Static Assets (Matching Nginx)
    <FilesMatch "\.(ico|css|js|woff2?|eot|ttf|svg|mp4|webp|jpg|jpeg|png|gif)$">
        Header set Cache-Control "public, no-transform"
    </FilesMatch>

    # Enable Laravel Pretty URLs (Equivalent to `try_files $uri $uri/ /index.php$is_args$args;`)
    <IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)$ /index.php/$1 [L]
    </IfModule>

    # Log File Locations
    ErrorLog ${APACHE_LOG_DIR}/{{SERVER_NAME}}.error.log
    CustomLog ${APACHE_LOG_DIR}/{{SERVER_NAME}}.access.log combined
</VirtualHost>
