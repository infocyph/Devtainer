ARG PHP_VERSION
FROM php:${PHP_VERSION:-8.3}-fpm

LABEL org.opencontainers.image.source=https://github.com/infocyph/Devtainer
LABEL org.opencontainers.image.description="PHP FPM"
LABEL org.opencontainers.image.licenses=MIT
LABEL org.opencontainers.image.authors=infocyph,abmmhasan

# System packages and sudo installation
ARG LINUX_PACKAGES
RUN apt update && apt upgrade -y && \
    apt install sudo ${LINUX_PACKAGES//,/ } -y && \
    apt clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* /var/cache/apt/archives/*

# PHP Extensions
ARG PHP_EXTENSIONS
COPY install-php-extensions /usr/local/bin/
RUN chmod +x /usr/local/bin/install-php-extensions
RUN install-php-extensions @composer ${PHP_EXTENSIONS//,/ } && composer self-update --clean-backups
ENV COMPOSER_ALLOW_SUPERUSER=1

# NodeJS
ARG NODE_VERSION
RUN ["/bin/bash", "-c", "if [[ -n \"$NODE_VERSION\" ]]; then curl -fsSL https://deb.nodesource.com/setup_$NODE_VERSION.x | bash - && apt install nodejs -y && npm i -g npm@latest; fi"]

# Add synced system user
ARG UID
ARG GID
RUN useradd -G ${GID:-root} -u ${UID:-1000} -d /home/devuser devuser && \
    mkdir -p /home/devuser/.composer && \
    chown -R devuser:devuser /home/devuser && \
    echo "devuser ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/devuser

USER devuser
WORKDIR /app
