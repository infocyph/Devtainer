#!/usr/bin/env bash
set -euo pipefail

die() { echo "Error: $*" >&2; exit 1; }

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
ENV_FILE="$ROOT_DIR/docker/.env"

is_msys() {
  case "${OSTYPE:-}" in
  msys*|cygwin*) return 0 ;;
  *) return 1 ;;
  esac
}

msys_no_pathconv() {
  if is_msys; then
    export MSYS_NO_PATHCONV=1
    export MSYS2_ARG_CONV_EXCL='*'
  fi
}

resolve_mount_root() {
  local posix_root="" host_path=""

  if [[ -n "${WORKDIR:-}" && -d "${WORKDIR}" ]]; then
    posix_root="$WORKDIR"
  fi

  if [[ -z "$posix_root" && -n "${WORKDIR_WIN:-}" ]]; then
    if command -v cygpath >/dev/null 2>&1; then
      posix_root="$(cygpath -u "$WORKDIR_WIN" 2>/dev/null || true)"
    fi
  fi

  if [[ -z "$posix_root" && -n "${WORKING_DIR:-}" ]]; then
    if [[ -d "$WORKING_DIR" ]]; then
      posix_root="$WORKING_DIR"
    else
      if command -v cygpath >/dev/null 2>&1; then
        posix_root="$(cygpath -u "$WORKING_DIR" 2>/dev/null || true)"
      fi
    fi
  fi

  [[ -n "$posix_root" && -d "$posix_root" ]] || posix_root="$PWD"
  posix_root="$(cd "$posix_root" && pwd)"

  if is_msys; then
    if command -v cygpath >/dev/null 2>&1; then
      host_path="$(cygpath -w "$posix_root")"
    else
      host_path="$posix_root"
    fi
  else
    host_path="$posix_root"
  fi

  case "$host_path" in
  *"Program Files/Git/workspace"*|*"Program Files\\Git\\workspace"*)
    if is_msys && command -v cygpath >/dev/null 2>&1; then
      host_path="$(cygpath -w "$posix_root")"
    fi
    ;;
  esac

  MOUNT_POSIX_ROOT="$posix_root"
  MOUNT_HOST_PATH="$host_path"
}


MOUNT_POSIX_ROOT=""
MOUNT_HOST_PATH=""

if [[ -r "$ENV_FILE" ]]; then
  while IFS='=' read -r k v; do
    [[ -z "${k:-}" || "$k" =~ ^[[:space:]]*# ]] && continue
    k="${k//[[:space:]]/}"
    case "$k" in
    MYSQL_CONTAINER|MYSQL_PORT_IN|MYSQL_ROOT_PASSWORD|MYSQL_DATABASE|WORKING_DIR) ;;
    *) continue ;;
    esac
    v="${v%$'\r'}"
    v="${v#\"}"; v="${v%\"}"
    v="${v#\'}"; v="${v%\'}"
    export "$k=$v"
  done <"$ENV_FILE"
fi

SERVICE="${MYSQL_CONTAINER:-MYSQL}"
MYSQL_PORT_IN="${MYSQL_PORT_IN:-}"

require_container() { docker inspect "$SERVICE" >/dev/null 2>&1 || die "container '$SERVICE' is not running."; }

cenv() {
  local key="$1"
  docker exec -i "$SERVICE" sh -lc 'printf "%s" "${!1-}"' sh "$key"
}

mysql_image() {
  docker inspect -f '{{.Config.Image}}' "$SERVICE" 2>/dev/null || die "failed to inspect image for '$SERVICE'."
}

infer_port() {
  [[ -n "${MYSQL_PORT_IN:-}" ]] && return 0
  MYSQL_PORT_IN="$(cenv MYSQL_PORT 2>/dev/null || true)"
  MYSQL_PORT_IN="${MYSQL_PORT_IN:-3306}"
}

run_client_mount_pwd() {
  local image="$1"
  shift
  local flags=()
  [[ -t 0 ]] && flags+=(-it) || flags+=(-i)

  msys_no_pathconv

  docker run --rm "${flags[@]}" \
    -v "$MOUNT_HOST_PATH":/workspace -w /workspace \
    --network "container:$SERVICE" \
    "$image" "$@"
}

usage() {
  cat >&2 <<'TXT'
Usage:
  mysqldump dump [db] [out.sql]
  mysqldump dump-all [out.sql]
  mysqldump schema [db] [out.sql]       # no data
  mysqldump data [db] [out.sql]         # no schema
  mysqldump [raw mysqldump args...]     # streams to stdout (no file writing)
TXT
}

main() {
  require_container
  infer_port
  resolve_mount_root
  msys_no_pathconv

  local ROOT_PW DB IMAGE
  ROOT_PW="$(cenv MYSQL_ROOT_PASSWORD 2>/dev/null || true)"
  DB="$(cenv MYSQL_DATABASE 2>/dev/null || true)"
  IMAGE="$(mysql_image)"

  [[ -n "${ROOT_PW:-}" ]] || ROOT_PW="${MYSQL_ROOT_PASSWORD:-}"
  [[ -n "${DB:-}" ]] || DB="${MYSQL_DATABASE:-}"

  local cmd="${1:-}"
  case "$cmd" in
  ""|-h|--help|help) usage; exit 0 ;;
  esac

  case "$cmd" in
  dump)
    shift
    local db="${1:-$DB}"
    [[ -n "$db" ]] || die "dump requires a db name (or set MYSQL_DATABASE)."
    local out="${2:-${db}.sql}"

    run_client_mount_pwd "$IMAGE" sh -lc '
        db="$1"; out="$2"; pw="$3"; port="$4"
        umask 077
        cf="$(mktemp)"; trap "rm -f $cf" EXIT
        cat >"$cf" <<EOF
[client]
user=root
password=$pw
host=127.0.0.1
port=$port
protocol=TCP
EOF
        exec mysqldump --defaults-extra-file="$cf" \
          --single-transaction --quick --routines --events \
          "$db" > "/workspace/$out"
      ' sh "$db" "$out" "$ROOT_PW" "$MYSQL_PORT_IN"

    echo "OK: dumped '$db' -> ./$out" >&2
    ;;

  dump-all)
    shift
    local out="${1:-all.sql}"

    run_client_mount_pwd "$IMAGE" sh -lc '
        out="$1"; pw="$2"; port="$3"
        umask 077
        cf="$(mktemp)"; trap "rm -f $cf" EXIT
        cat >"$cf" <<EOF
[client]
user=root
password=$pw
host=127.0.0.1
port=$port
protocol=TCP
EOF
        exec mysqldump --defaults-extra-file="$cf" \
          --single-transaction --quick --routines --events \
          --all-databases > "/workspace/$out"
      ' sh "$out" "$ROOT_PW" "$MYSQL_PORT_IN"

    echo "OK: dumped all databases -> ./$out" >&2
    ;;

  schema)
    shift
    local db="${1:-$DB}"
    [[ -n "$db" ]] || die "schema requires a db name (or set MYSQL_DATABASE)."
    local out="${2:-${db}.schema.sql}"

    run_client_mount_pwd "$IMAGE" sh -lc '
        db="$1"; out="$2"; pw="$3"; port="$4"
        umask 077
        cf="$(mktemp)"; trap "rm -f $cf" EXIT
        cat >"$cf" <<EOF
[client]
user=root
password=$pw
host=127.0.0.1
port=$port
protocol=TCP
EOF
        exec mysqldump --defaults-extra-file="$cf" \
          --no-data --routines --events \
          "$db" > "/workspace/$out"
      ' sh "$db" "$out" "$ROOT_PW" "$MYSQL_PORT_IN"

    echo "OK: schema dumped '$db' -> ./$out" >&2
    ;;

  data)
    shift
    local db="${1:-$DB}"
    [[ -n "$db" ]] || die "data requires a db name (or set MYSQL_DATABASE)."
    local out="${2:-${db}.data.sql}"

    run_client_mount_pwd "$IMAGE" sh -lc '
        db="$1"; out="$2"; pw="$3"; port="$4"
        umask 077
        cf="$(mktemp)"; trap "rm -f $cf" EXIT
        cat >"$cf" <<EOF
[client]
user=root
password=$pw
host=127.0.0.1
port=$port
protocol=TCP
EOF
        exec mysqldump --defaults-extra-file="$cf" \
          --no-create-info --skip-triggers \
          --single-transaction --quick \
          "$db" > "/workspace/$out"
      ' sh "$db" "$out" "$ROOT_PW" "$MYSQL_PORT_IN"

    echo "OK: data dumped '$db' -> ./$out" >&2
    ;;

  *)
    exec docker exec -i "$SERVICE" sh -lc '
        umask 077
        cf="$(mktemp)"; trap "rm -f $cf" EXIT
        cat >"$cf" <<EOF
[client]
user=root
password=${MYSQL_ROOT_PASSWORD-}
host=127.0.0.1
port=${MYSQL_PORT_IN-${MYSQL_PORT-3306}}
protocol=TCP
EOF
        exec mysqldump --defaults-extra-file="$cf" "$@"
      ' sh "$@"
    ;;
  esac
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "$@"
fi
