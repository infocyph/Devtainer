#!/usr/bin/env bash
set -euo pipefail

die() {
  echo "Error: $*" >&2
  exit 1
}

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
ENV_FILE="$ROOT_DIR/docker/.env"

# Safe host .env load (optional; whitelist)
if [[ -r "$ENV_FILE" ]]; then
  while IFS='=' read -r k v; do
    [[ -z "${k:-}" || "$k" =~ ^[[:space:]]*# ]] && continue
    k="${k//[[:space:]]/}"
    case "$k" in
    REDIS_CONTAINER | REDIS_DB | REDIS_PASSWORD) ;;
    *) continue ;;
    esac
    v="${v%$'\r'}"
    v="${v#\"}"
    v="${v%\"}"
    v="${v#\'}"
    v="${v%\'}"
    export "$k=$v"
  done <"$ENV_FILE"
fi

SERVICE="${REDIS_CONTAINER:-REDIS}"

require_container() { docker inspect "$SERVICE" >/dev/null 2>&1 || die "container '$SERVICE' is not running."; }
is_tty() { [[ -t 0 ]] && echo "-it" || echo "-i"; }

# Read env var from container (best source of truth)
cenv() {
  local key="$1"
  docker exec -i "$SERVICE" sh -lc 'printf "%s" "${!1-}"' sh "$key" 2>/dev/null || true
}

redis_password() {
  local pw="${REDIS_PASSWORD:-}"
  [[ -n "$pw" ]] && {
    printf '%s' "$pw"
    return 0
  }
  pw="$(cenv REDIS_PASSWORD || true)"
  printf '%s' "$pw"
}

redis_db() {
  local db="${REDIS_DB:-}"
  [[ -n "$db" ]] || db="0"
  printf '%s' "$db"
}

usage() {
  cat >&2 <<'TXT'
Usage:
  redis-cli                     # interactive
  redis-cli <args...>            # passthrough

Shortcuts:
  redis-cli db <index> [cmd...]  # run on a specific DB index
  redis-cli status
TXT
}

redis_exec() {
  local flags
  flags="$(is_tty)"
  local pw db
  pw="$(redis_password)"
  db="$(redis_db)"
  if [[ -n "$pw" ]]; then
    exec docker exec $flags -e "REDISCLI_AUTH=$pw" "$SERVICE" redis-cli -n "$db" "$@"
  else
    exec docker exec $flags "$SERVICE" redis-cli -n "$db" "$@"
  fi
}

main() {
  require_container

  if [[ $# -eq 0 ]]; then
    redis_exec
    exit 0
  fi

  case "${1:-}" in
  -h | --help | help)
    usage
    exit 0
    ;;
  status)
    docker ps --filter "name=^/${SERVICE}$" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
    exit 0
    ;;
  db)
    shift
    local idx="${1:-}"
    [[ -n "$idx" ]] || die "db requires an index."
    [[ "$idx" =~ ^[0-9]+$ ]] || die "db index must be numeric."
    shift || true

    local flags
    flags="$(is_tty)"
    local pw
    pw="$(redis_password)"
    if [[ -n "$pw" ]]; then
      exec docker exec $flags -e "REDISCLI_AUTH=$pw" "$SERVICE" redis-cli -n "$idx" "$@"
    else
      exec docker exec $flags "$SERVICE" redis-cli -n "$idx" "$@"
    fi
    ;;
  *)
    redis_exec "$@"
    ;;
  esac
}

main "$@"
