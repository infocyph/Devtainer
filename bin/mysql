#!/usr/bin/env bash
set -euo pipefail

SERVICE="${MYSQL_CONTAINER:-MYSQL}"

die() {
  echo "Error: $*" >&2
  exit 1
}

require_container() {
  docker ps --format '{{.Names}}' | grep -qx "$SERVICE" ||
    die "container '$SERVICE' is not running."
}

is_tty() { [[ -t 0 ]] && echo "-it" || echo "-i"; }

# Read env var from inside the running mysql container (no host .env required)
cenv() {
  local key="$1"
  docker exec -i "$SERVICE" sh -lc 'printf "%s" "${!1-}"' sh "$key"
}

# mysql server image (we re-use it for ephemeral client runs)
mysql_image() {
  docker inspect -f '{{.Config.Image}}' "$SERVICE" 2>/dev/null ||
    die "failed to inspect image for '$SERVICE'."
}

# Exec mysql client inside the running container (no mounts)
mysql_exec_root() {
  local flags
  flags="$(is_tty)"
  exec docker exec $flags "$SERVICE" sh -lc '
    MYSQL_PWD="${MYSQL_ROOT_PASSWORD-}" exec mysql -uroot "$@"
  ' sh "$@"
}

mysql_exec_user() {
  local flags
  flags="$(is_tty)"
  exec docker exec $flags "$SERVICE" sh -lc '
    MYSQL_PWD="${MYSQL_PASSWORD-}" exec mysql -u"${MYSQL_USER-}" "$@"
  ' sh "$@"
}

# Ephemeral client container with dynamic mount of current dir
# Uses --network container:MYSQL so it can talk to the server via 127.0.0.1
run_client() {
  local image="$1"
  shift
  local root_pw="$1"
  shift
  local user="$1"
  shift
  local user_pw="$1"
  shift

  docker run --rm -v "$PWD":/workspace -w /workspace --network "container:$SERVICE" \
    -e MYSQL_ROOT_PASSWORD="$root_pw" \
    -e MYSQL_USER="$user" \
    -e MYSQL_PASSWORD="$user_pw" \
    "$image" "$@"
}

usage() {
  cat >&2 <<'TXT'
Usage:
  mysql [--user] [mysql args...]
  mysql create-db [db_name]
  mysql import <file.sql|file.sql.gz> [db_name]
  mysql export [db_name] [out.sql]
  mysql dump   [db_name] [out.sql]     # alias of export
  mysql status

Behavior:
- Default (no subcommand): runs mysql client INSIDE the running container as root
- File ops (import/export): uses an ephemeral container with -v "$PWD":/workspace (dynamic mount)
TXT
}

main() {
  require_container

  local as_user=false
  if [[ "${1:-}" == "--user" ]]; then
    as_user=true
    shift
  fi

  local cmd="${1:-}"
  case "$cmd" in
  "" | help | -h | --help)
    usage
    exit 0
    ;;
  status)
    docker ps --filter "name=^/${SERVICE}$" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
    exit 0
    ;;
  esac

  # Defaults from container env
  local ROOT_PW USER USER_PW DEF_DB IMAGE
  ROOT_PW="$(cenv MYSQL_ROOT_PASSWORD)"
  USER="$(cenv MYSQL_USER)"
  USER_PW="$(cenv MYSQL_PASSWORD)"
  DEF_DB="$(cenv MYSQL_DATABASE)"
  IMAGE="$(mysql_image)"

  case "$cmd" in
  create-db)
    shift
    local db="${1:-$DEF_DB}"
    [[ -n "$db" ]] || die "create-db requires a db name (or set MYSQL_DATABASE in container)."

    # run inside container (no mount needed)
    docker exec -i "$SERVICE" sh -lc '
        db="$1"
        MYSQL_PWD="${MYSQL_ROOT_PASSWORD-}" \
          mysql -uroot -e "
            CREATE DATABASE IF NOT EXISTS \`$db\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
            GRANT ALL PRIVILEGES ON \`$db\`.* TO '\''${MYSQL_USER-}'\''@'\'%'\'';
            FLUSH PRIVILEGES;
          "
      ' sh "$db"
    echo "OK: database '$db' ensured + privileges granted to $USER" >&2
    ;;

  import)
    shift
    local file="${1:-}"
    shift || true
    [[ -n "$file" ]] || die "import requires a file path (.sql or .sql.gz)."
    [[ -f "$file" ]] || die "file not found: $file"

    local db="${1:-$DEF_DB}"
    [[ -n "$db" ]] || die "import requires a db name (or set MYSQL_DATABASE in container)."

    # ephemeral container mounts $PWD -> /workspace
    if [[ "$file" == *.gz ]]; then
      run_client "$IMAGE" "$ROOT_PW" "$USER" "$USER_PW" sh -lc '
          db="$1"; f="$2"
          gunzip -c "/workspace/$f" | MYSQL_PWD="$MYSQL_ROOT_PASSWORD" mysql -uroot "$db"
        ' sh "$db" "$(basename "$file")"
    else
      run_client "$IMAGE" "$ROOT_PW" "$USER" "$USER_PW" sh -lc '
          db="$1"; f="$2"
          MYSQL_PWD="$MYSQL_ROOT_PASSWORD" mysql -uroot "$db" < "/workspace/$f"
        ' sh "$db" "$(basename "$file")"
    fi
    echo "OK: imported '$file' -> db '$db'" >&2
    ;;

  export | dump)
    shift
    local db="${1:-$DEF_DB}"
    [[ -n "$db" ]] || die "export requires a db name (or set MYSQL_DATABASE in container)."
    local out="${2:-${db}.sql}"

    # ephemeral container writes directly to /workspace (host current dir)
    run_client "$IMAGE" "$ROOT_PW" "$USER" "$USER_PW" sh -lc '
        db="$1"; out="$2"
        MYSQL_PWD="$MYSQL_ROOT_PASSWORD" mysqldump -uroot \
          --single-transaction --quick --routines --events "$db" > "/workspace/$out"
      ' sh "$db" "$out"
    echo "OK: exported db '$db' -> ./$out" >&2
    ;;

  *)
    # Default: "mysql ..." means root login using container env
    if [[ "$as_user" == true ]]; then
      shift 0
      mysql_exec_user "$@"
    else
      shift 0
      mysql_exec_root "$@"
    fi
    ;;
  esac
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "$@"
fi
